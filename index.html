<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background-color: #f8f8f8;
        }
        header {
            background-color: red;
            color: yellow;
            padding: 15px;
        }
        nav a {
            color: yellow;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
        }
        main {
            padding: 20px;
        }
        table {
            width: 80%;
            margin: auto;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            border: 1px solid black;
            padding: 10px;
        }
        form input, form button {
            padding: 10px;
            margin: 5px;
        }
        .kasir-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .item-button {
            margin: 5px;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            cursor: pointer;
            width: 100%;
        }
        .item-button:hover {
            background-color: #ddd;
        }
        .total-bayar {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
        }
        .pembayaran {
            margin-top: 20px;
        }
        .pembayaran input {
            padding: 10px;
            margin: 5px;
            width: 100%;
        }
        .kembalian {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            color: green;
        }
        .daftar-item-kasir {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .daftar-belanja table {
            width: 100%;
        }
        .daftar-belanja th, .daftar-belanja td {
            padding: 8px;
        }
        .metode-pembayaran {
            margin-top: 20px;
        }
        .metode-pembayaran button {
            padding: 10px;
            margin: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .metode-pembayaran button.active {
            background-color: #4CAF50;
            color: white;
        }
        #grab-total-harga {
            margin-top: 10px;
        }
        .tutup-merah {
            background-color: red;
            color: white;
        }
        .lunas {
            color: green;
            font-weight: bold;
        }
        .total-keseluruhan {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 20px;
        }
        .filter-button {
            margin: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .filter-button:hover {
            background-color: #45a049;
        }
        .batalkan-perubahan {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin-left: 10px;
        }
        .batalkan-perubahan:hover {
            background-color: #cc0000;
        }
        .penghitung-item {
            margin-top: 20px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

<header>
    <h1>Kasir</h1>
    <nav>
        <a href="#" onclick="tampilkanHalaman('kasir')">Kasir</a> |
        <a href="#" onclick="tampilkanHalaman('database')">Kelola Item & Harga</a>
    </nav>
</header>

<main>
    <!-- Halaman Kasir -->
    <section id="kasir">
        <!-- Tombol Input Baru -->
        <button onclick="bukaKasir()">Input Baru</button>

        <h2>Riwayat Penjualan</h2>

        <!-- Tombol Filter -->
        <button class="filter-button" onclick="tampilkanSemua()">Semua</button>
        <button class="filter-button" onclick="filterCash()">Cash</button>
        <button class="filter-button" onclick="filterCashless()">Cashless</button>

        <table>
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama Item</th>
                    <th>Jumlah</th>
                    <th>Total Harga</th>
                    <th>Keterangan</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="riwayat-penjualan">
                <!-- Data riwayat penjualan akan ditampilkan di sini -->
            </tbody>
        </table>

        <!-- Total Keseluruhan -->
        <div class="total-keseluruhan" id="total-keseluruhan">
            Total Keseluruhan: Rp 0
        </div>

        <!-- Penghitung Item Terjual -->
        <div class="penghitung-item" id="penghitung-item">
            <p>Bakso: 0 Porsi</p>
            <p>Pangsit: 0 Porsi</p>
            <p>Ketupat: 0 Biji</p>
            <p>Bakwan: 0 Biji</p>
            <p>Kacang: 0 Bungkus</p>
        </div>

        <!-- Pop-up Kasir -->
        <div class="overlay" id="overlay"></div>
        <div class="kasir-popup" id="kasir-popup">
            <h2>Kasir</h2>
            <div class="daftar-item-kasir" id="daftar-item-kasir">
                <!-- Tombol item akan ditampilkan di sini -->
            </div>
            <h3>Daftar Belanja</h3>
            <div class="daftar-belanja">
                <table>
                    <thead>
                        <tr>
                            <th>Nama Item</th>
                            <th>Jumlah</th>
                            <th>Harga Satuan</th>
                            <th>Total Harga</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="daftar-belanja">
                        <!-- Daftar belanja akan ditampilkan di sini -->
                    </tbody>
                </table>
            </div>
            <div class="total-bayar" id="total-bayar">
                Total Bayar: Rp 0
            </div>
            <div class="pembayaran">
                <input type="text" id="uang-pembayaran" placeholder="Uang Pembayaran (Rp)" oninput="formatInput(this)">
                <div id="grab-total-harga" style="display: none;">
                    <input type="text" id="total-harga-grab" placeholder="Total Harga GRAB (Rp)" oninput="formatInput(this)">
                </div>
                <button onclick="hitungKembalian()">Hitung Kembalian</button>
            </div>
            <div class="kembalian" id="kembalian">
                Kembalian: Rp 0
            </div>
            <div class="metode-pembayaran">
                <button onclick="pilihMetodePembayaran('CASH')">CASH</button>
                <button onclick="pilihMetodePembayaran('QRIS')">QRIS</button>
                <button onclick="pilihMetodePembayaran('TF')">TF</button>
                <button onclick="pilihMetodePembayaran('GRAB')">GRAB</button>
            </div>
            <button onclick="simpanTransaksi()">Simpan Transaksi</button>
            <button onclick="tutupKasir()">Tutup</button>
            <button class="batalkan-perubahan" id="batalkan-perubahan" onclick="batalkanPerubahan()" style="display: none;">Batalkan Perubahan</button>
        </div>
    </section>

    <!-- Halaman Kelola Item & Harga -->
    <section id="database" style="display: none;">
        <h2>Tambah Item</h2>
        <form id="form-item">
            <input type="text" id="nama-item" placeholder="Nama Item" required>
            <input type="text" id="harga-item" placeholder="Harga (Rp)" oninput="formatInput(this)" required>
            <button type="submit">Tambahkan</button>
        </form>

        <h2>Daftar Item</h2>
        <table>
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama Item</th>
                    <th>Harga</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="daftar-item">
                <!-- Data item akan ditampilkan di sini -->
            </tbody>
        </table>
    </section>
</main>

<script>
    // Fungsi untuk memformat angka dengan pemisah ribuan (titik)
    function formatRupiah(angka) {
        return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // Fungsi untuk menghapus pemisah ribuan (titik) dan mengembalikan angka biasa
    function hapusPemisahRibuan(angka) {
        return angka.replace(/\./g, "");
    }

    // Fungsi untuk memformat input saat pengguna mengetik
    function formatInput(input) {
        let nilai = input.value;
        let nilaiTanpaPemisah = hapusPemisahRibuan(nilai);
        if (!isNaN(nilaiTanpaPemisah)) {
            input.value = formatRupiah(nilaiTanpaPemisah);
        } else {
            input.value = ""; // Reset jika input tidak valid
        }
    }

    let metodePembayaranTerpilih = "";
    let indexTransaksiEdit = null; // Menyimpan indeks transaksi yang sedang diedit

    function pilihMetodePembayaran(metode) {
        metodePembayaranTerpilih = metode;
        // Hapus kelas active dari semua tombol
        document.querySelectorAll('.metode-pembayaran button').forEach(button => {
            button.classList.remove('active');
        });
        // Tambahkan kelas active ke tombol yang dipilih
        document.querySelector(`.metode-pembayaran button[onclick="pilihMetodePembayaran('${metode}')"]`).classList.add('active');

        // Tampilkan input total harga GRAB jika metode pembayaran adalah GRAB
        if (metode === "GRAB") {
            document.getElementById("grab-total-harga").style.display = "block";
        } else {
            document.getElementById("grab-total-harga").style.display = "none";
        }
    }

    function tampilkanRiwayat(filter = null) {
        let riwayat = JSON.parse(localStorage.getItem("riwayatPenjualan")) || [];
        let riwayatPenjualan = document.getElementById("riwayat-penjualan");
        let totalKeseluruhan = 0;

        // Kosongkan tabel riwayat penjualan
        riwayatPenjualan.innerHTML = "";

        // Filter data berdasarkan metode pembayaran
        if (filter === "CASH") {
            riwayat = riwayat.filter(item => item.keterangan === "CASH");
        } else if (filter === "CASHLESS") {
            riwayat = riwayat.filter(item => item.keterangan !== "CASH");
        }

        // Tampilkan riwayat penjualan
        riwayat.forEach((item, index) => {
            totalKeseluruhan += item.total;
            let row = `<tr>
                <td>${index + 1}</td>
                <td>${item.nama}</td>
                <td>${item.jumlah}</td>
                <td class="${item.lunas ? 'lunas' : ''}">Rp ${formatRupiah(item.total)}</td>
                <td>${item.keterangan}</td>
                <td>
                    <button onclick="tandaiLunas(${index})">Lunas</button>
                    <button onclick="editTransaksi(${index})">Edit</button>
                    <button onclick="hapusTransaksi(${index})">Hapus</button>
                </td>
            </tr>`;
            riwayatPenjualan.innerHTML += row;
        });

        // Tampilkan total keseluruhan
        document.getElementById("total-keseluruhan").innerText = `Total Keseluruhan: Rp ${formatRupiah(totalKeseluruhan)}`;

        // Hitung dan tampilkan penghitung item terjual
        hitungItemTerjual(riwayat);
    }

    function hitungItemTerjual(riwayat) {
        let penghitung = {
            Bakso: 0,
            Pangsit: 0,
            Ketupat: 0,
            Bakwan: 0,
            Kacang: 0,
        };

        riwayat.forEach((transaksi) => {
            transaksi.nama.split(", ").forEach((item) => {
                let [jumlah, ...nama] = item.split(" ");
                let namaItem = nama.join(" ");
                if (penghitung.hasOwnProperty(namaItem)) {
                    penghitung[namaItem] += parseInt(jumlah);
                }
            });
        });

        // Tampilkan hasil penghitungan
        document.getElementById("penghitung-item").innerHTML = `
            <p>Bakso: ${penghitung.Bakso} Porsi</p>
            <p>Pangsit: ${penghitung.Pangsit} Porsi</p>
            <p>Ketupat: ${penghitung.Ketupat} Biji</p>
            <p>Bakwan: ${penghitung.Bakwan} Biji</p>
            <p>Kacang: ${penghitung.Kacang} Bungkus</p>
        `;
    }

    function tampilkanSemua() {
        tampilkanRiwayat(); // Tampilkan semua riwayat penjualan
    }

    function filterCash() {
        tampilkanRiwayat("CASH");
    }

    function filterCashless() {
        tampilkanRiwayat("CASHLESS");
    }

    document.addEventListener("DOMContentLoaded", function () {
        tampilkanSemua(); // Tampilkan semua riwayat penjualan saat halaman dimuat

        // Ambil data daftar item dari localStorage
        let daftar = JSON.parse(localStorage.getItem("daftarItem")) || [];
        let daftarItem = document.getElementById("daftar-item");

        // Tampilkan daftar item
        daftar.forEach((item, index) => {
            let row = `<tr>
                <td>${index + 1}</td>
                <td>${item.nama}</td>
                <td>Rp ${formatRupiah(item.harga)}</td>
                <td>
                    <button onclick="hapusItem(${index})">Hapus</button>
                </td>
            </tr>`;
            daftarItem.innerHTML += row;
        });

        // Tambah item ke daftar
        let formItem = document.getElementById("form-item");
        formItem.addEventListener("submit", function (e) {
            e.preventDefault();
            let nama = document.getElementById("nama-item").value;
            let harga = hapusPemisahRibuan(document.getElementById("harga-item").value);

            let newItem = { nama, harga };
            daftar.push(newItem);
            localStorage.setItem("daftarItem", JSON.stringify(daftar));

            let row = `<tr>
                <td>${daftar.length}</td>
                <td>${nama}</td>
                <td>Rp ${formatRupiah(harga)}</td>
                <td>
                    <button onclick="hapusItem(${daftar.length - 1})">Hapus</button>
                </td>
            </tr>`;
            daftarItem.innerHTML += row;

            formItem.reset();
        });
    });

    function tampilkanHalaman(halaman) {
        document.getElementById("kasir").style.display = (halaman === 'kasir') ? "block" : "none";
        document.getElementById("database").style.display = (halaman === 'database') ? "block" : "none";
    }

    function bukaKasir() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("kasir-popup").style.display = "block";

        // Ambil data daftar item dari localStorage
        let daftar = JSON.parse(localStorage.getItem("daftarItem")) || [];
        let daftarItemKasir = document.getElementById("daftar-item-kasir");

        // Kosongkan daftar item kasir
        daftarItemKasir.innerHTML = "";

        // Tampilkan tombol item
        daftar.forEach((item) => {
            let button = `<button class="item-button" onclick="tambahKeBelanja('${item.nama}', ${item.harga})">${item.nama} - Rp ${formatRupiah(item.harga)}</button>`;
            daftarItemKasir.innerHTML += button;
        });

        // Perbarui daftar belanja
        perbaruiDaftarBelanja();
    }

    function tutupKasir() {
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        if (belanja.length > 0) {
            alert("Tolong Selesaikan Transaksi!");
            return; // Jangan tutup pop-up jika ada item dalam daftar belanja
        }

        document.getElementById("overlay").style.display = "none";
        document.getElementById("kasir-popup").style.display = "none";
    }

    function tambahKeBelanja(nama, harga) {
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        let item = belanja.find((item) => item.nama === nama);

        if (item) {
            item.jumlah += 1; // Tambah jumlah jika item sudah ada
        } else {
            belanja.push({ nama, harga, jumlah: 1 }); // Tambah item baru ke belanja
        }

        localStorage.setItem("belanja", JSON.stringify(belanja));
        perbaruiDaftarBelanja();
    }

    function perbaruiDaftarBelanja() {
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        let daftarBelanja = document.getElementById("daftar-belanja");
        let totalBayar = 0;

        // Gabungkan item yang sama
        let belanjaGabung = [];
        belanja.forEach((item) => {
            let itemExist = belanjaGabung.find((i) => i.nama === item.nama);
            if (itemExist) {
                itemExist.jumlah += item.jumlah;
            } else {
                belanjaGabung.push({ ...item });
            }
        });

        // Kosongkan daftar belanja
        daftarBelanja.innerHTML = "";

        // Tampilkan item belanja
        belanjaGabung.forEach((item, index) => {
            let totalHarga = item.harga * item.jumlah;
            totalBayar += totalHarga;

            let row = `<tr>
                <td>${item.nama}</td>
                <td>${item.jumlah}</td>
                <td>Rp ${formatRupiah(item.harga)}</td>
                <td>Rp ${formatRupiah(totalHarga)}</td>
                <td>
                    <button onclick="hapusDariBelanja('${item.nama}')">Hapus</button>
                </td>
            </tr>`;
            daftarBelanja.innerHTML += row;
        });

        // Tampilkan total bayar
        document.getElementById("total-bayar").innerText = `Total Bayar: Rp ${formatRupiah(totalBayar)}`;

        // Ubah warna tombol Tutup jika ada item dalam daftar belanja
        let tombolTutup = document.querySelector("#kasir-popup button[onclick='tutupKasir()']");
        if (belanja.length > 0) {
            tombolTutup.classList.add("tutup-merah");
        } else {
            tombolTutup.classList.remove("tutup-merah");
        }
    }

    function hapusDariBelanja(nama) {
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        belanja = belanja.filter((item) => item.nama !== nama); // Hapus item dari belanja
        localStorage.setItem("belanja", JSON.stringify(belanja));
        perbaruiDaftarBelanja();
    }

    function hitungKembalian() {
        let totalBayar = parseFloat(hapusPemisahRibuan(document.getElementById("total-bayar").innerText.replace("Total Bayar: Rp ", "")));
        let uangPembayaran = parseFloat(hapusPemisahRibuan(document.getElementById("uang-pembayaran").value));

        if (isNaN(uangPembayaran)) {
            alert("Masukkan jumlah uang pembayaran!");
            return;
        }

        if (uangPembayaran < totalBayar) {
            alert("Uang pembayaran tidak cukup!");
            return;
        }

        let kembalian = uangPembayaran - totalBayar;
        document.getElementById("kembalian").innerText = `Kembalian: Rp ${formatRupiah(kembalian)}`;
    }

    function simpanTransaksi() {
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        if (belanja.length === 0) {
            alert("Belanjaan kosong!");
            return;
        }

        let riwayat = JSON.parse(localStorage.getItem("riwayatPenjualan")) || [];
        let totalBayar = belanja.reduce((total, item) => total + item.harga * item.jumlah, 0);

        // Jika metode pembayaran adalah GRAB, gunakan total harga GRAB
        if (metodePembayaranTerpilih === "GRAB") {
            let totalHargaGrab = hapusPemisahRibuan(document.getElementById("total-harga-grab").value);
            if (!totalHargaGrab || isNaN(totalHargaGrab)) {
                alert("Masukkan total harga GRAB yang valid!");
                return;
            }
            totalBayar = parseFloat(totalHargaGrab);
        }

        // Format nama item dengan jumlah (misal: "2 Bakso Ori, 3 Bakso Telur")
        let namaItem = belanja.map(item => `${item.jumlah} ${item.nama}`).join(", ");

        let transaksi = {
            nama: namaItem,
            jumlah: belanja.reduce((total, item) => total + item.jumlah, 0),
            total: totalBayar,
            keterangan: metodePembayaranTerpilih || "CASH", // Default ke CASH jika tidak ada metode yang dipilih
            lunas: false, // Default status lunas
        };

        if (indexTransaksiEdit !== null) {
            // Jika sedang dalam mode edit, perbarui transaksi yang ada
            riwayat[indexTransaksiEdit] = transaksi;
            indexTransaksiEdit = null; // Reset mode edit
        } else {
            // Jika tidak, tambahkan transaksi baru
            riwayat.push(transaksi);
        }

        localStorage.setItem("riwayatPenjualan", JSON.stringify(riwayat));
        localStorage.removeItem("belanja"); // Kosongkan belanja
        metodePembayaranTerpilih = ""; // Reset metode pembayaran
        tutupKasir();
        location.reload(); // Muat ulang halaman untuk memperbarui tampilan
    }

    function hapusItem(index) {
        let pin = prompt("Masukkan PIN untuk menghapus item:");
        if (pin !== "0000") {
            alert("PIN salah! Penghapusan dibatalkan.");
            return;
        }

        let daftar = JSON.parse(localStorage.getItem("daftarItem")) || [];
        daftar.splice(index, 1); // Hapus item dari array
        localStorage.setItem("daftarItem", JSON.stringify(daftar)); // Simpan kembali ke localStorage
        location.reload(); // Muat ulang halaman untuk memperbarui tampilan
    }

    function tandaiLunas(index) {
        let riwayat = JSON.parse(localStorage.getItem("riwayatPenjualan")) || [];
        riwayat[index].lunas = true; // Tandai sebagai lunas
        localStorage.setItem("riwayatPenjualan", JSON.stringify(riwayat));
        location.reload(); // Muat ulang halaman untuk memperbarui tampilan
    }

    function editTransaksi(index) {
        let riwayat = JSON.parse(localStorage.getItem("riwayatPenjualan")) || [];
        let transaksi = riwayat[index];

        // Simpan indeks transaksi yang sedang diedit
        indexTransaksiEdit = index;

        // Tambahkan item ke keranjang
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        transaksi.nama.split(", ").forEach((item) => {
            let [jumlah, ...nama] = item.split(" ");
            let namaItem = nama.join(" ");
            let harga = JSON.parse(localStorage.getItem("daftarItem")).find((item) => item.nama === namaItem).harga;
            belanja.push({ nama: namaItem, harga, jumlah: parseInt(jumlah) });
        });

        localStorage.setItem("belanja", JSON.stringify(belanja));

        // Aktifkan metode pembayaran sesuai transaksi
        pilihMetodePembayaran(transaksi.keterangan);

        // Jika metode GRAB, isi nilai total harga GRAB
        if (transaksi.keterangan === "GRAB") {
            document.getElementById("total-harga-grab").value = formatRupiah(transaksi.total);
        }

        // Tampilkan tombol "Batalkan Perubahan"
        document.getElementById("batalkan-perubahan").style.display = "inline-block";

        // Buka pop-up kasir
        bukaKasir();
    }

    function batalkanPerubahan() {
        // Reset mode edit
        indexTransaksiEdit = null;
        localStorage.removeItem("belanja"); // Kosongkan belanja
        document.getElementById("batalkan-perubahan").style.display = "none"; // Sembunyikan tombol "Batalkan Perubahan"
        tutupKasir();
    }

    function hapusTransaksi(index) {
        let pin = prompt("Masukkan PIN untuk menghapus transaksi:");
        if (pin !== "0000") {
            alert("PIN salah! Penghapusan dibatalkan.");
            return;
        }

        let riwayat = JSON.parse(localStorage.getItem("riwayatPenjualan")) || [];
        riwayat.splice(index, 1); // Hapus transaksi dari riwayat
        localStorage.setItem("riwayatPenjualan", JSON.stringify(riwayat));
        location.reload(); // Muat ulang halaman untuk memperbarui tampilan
    }
</script>

</body>
</html>
