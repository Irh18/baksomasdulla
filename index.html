<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bakso Mas Dulla</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background-color: #faf3dd;
            color: #333;
        }

        body.no-scroll {
            overflow: hidden;
        }

        header {
            background-color: #800020;
            color: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 10px 10px;
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 600;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
            font-size: 1.1em;
            transition: color 0.3s ease;
        }

        nav a:hover {
            color: #ffc107;
        }

        .date-filter {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            margin-top:10px;
        }

        .date-input {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1em;
        }

        .shift-buttons {
            margin-bottom: 10px;
        }

        .shift-buttons button {
            background: #800020;
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: white;
        }

        .shift-buttons button.active {
            background-color: green;
            font-weight: bold;
        }

        main {
            padding: 20px;
        }

        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #e9ecef;
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #800020;
            color: white;
            font-weight: 600;
        }

        tr {
            background-color: white;
        }

        tr.lunas {
            background-color: #d4edda;
            color: #155724;
        }

        form input, .pembayaran input, .kembalian, .total-bayar, .penghitung-item-box {
            padding: 12px;
            margin: 10px 5px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            width: calc(100% - 30px);
            box-sizing: border-box;
        }

        .total-bayar {
            display: inline-block;
            width: 50%;
            color: white;
            font-size: 30px;
            background-color: #218000;
            font-weight: bold;
        }

        form input:focus, .pembayaran input:focus {
            border-color: #800020;
            outline: none;
            box-shadow: 0 0 5px rgba(128, 0, 32, 0.5);
        }

        button {
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: white;
        }

        button.filter-button, button.batalkan-perubahan, .metode-pembayaran button {
            background-color: #800020;
        }

        button.filter-button:hover, button.batalkan-perubahan:hover, .metode-pembayaran button:hover {
            background-color: #6d001a;
            transform: translateY(-2px);
        }

        button.item-button {
            font-weight: bold;
            background-color: #d10000;
            color: white;
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            margin: 0px;
        }

        button.item-button:hover {
            background-color: #6d001a;
            color: #ffffff;
        }

        .metode-pembayaran button.active {
            background-color: green;
        }

        .tutup-merah {
            background-color: #e74c3c;
        }

        .lunas {
            background-color: #28a745;
            padding: 5px 10px;
            border-radius: 6px;
        }

        .penghitung-item-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .penghitung-item-box {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 10px;
            font-size: 15px;
            color: #800000;
            width: 150px;
            margin: 0px;
        }

        .kasir-popup, .overlay {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 10px;
        }

        .daftar-item-kasir {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .daftar-item-kasir .kolom {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .tombol-keranjang {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: green;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .tombol-keranjang:hover {
            background-color: #6d001a;
            transform: scale(1.1);
        }

        .tombol-aksi {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .tombol-aksi button {
            width: 80%;
            padding: 10px;
            font-size: 0.9em;
            margin: 0px 0;
        }

        .tombol-pengeluaran {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background-color: #800020;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .tombol-pengeluaran:hover {
            background-color: #218838;
            transform: scale(1.1);
        }

        .pengeluaran-container {
            margin-top: 20px;
        }

        .pengeluaran-container table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .pengeluaran-container th, .pengeluaran-container td {
            border: 1px solid #e9ecef;
            padding: 12px;
            text-align: center;
        }

        .pengeluaran-container th {
            background-color: #800020;
            color: white;
            font-weight: 600;
        }

        .form-pengeluaran-popup, .overlay {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 10px;
        }

        .form-pengeluaran-popup h2 {
            margin-bottom: 20px;
        }

        .form-pengeluaran-popup input {
            width: calc(100% - 30px);
            margin: 10px 5px;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1em;
        }

        .form-pengeluaran-popup button {
            margin: 10px 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            color: white;
        }

        .form-pengeluaran-popup button.filter-button {
            background-color: #800020;
        }

        .form-pengeluaran-popup button.batalkan-perubahan {
            background-color: #e74c3c;
        }

        .total-keseluruhan-container {
            display: flex;
            justify-content: space-evenly;
            margin-top: 20px;
        }

        .total-keseluruhan-item {
            font-size: 1.2em;
            font-weight: bold;
            color: #800020;
        }

        .total-pengeluaran {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            color: #800020;
        }

        .penutupan-buku-container {
            display: inline-grid;
            justify-content: center;
            width: 90%;
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .penutupan-buku-container h2 {
            font-size: 1.5em;
            color: #800020;
            margin-bottom: 40px;
        }

        .penutupan-buku-container small {
            display: block;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #555;
        }

        .penutupan-buku-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .penutupan-buku-row input, .penutupan-buku-row span {
            padding: 10px;
            font-size: 1em;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 6px;
        }

        .penutupan-buku-row input {
            width: 150px;
        }

        .penutupan-buku-row span {
            width: 100px;
            display: inline-block;
        }
        .floating-label-group {
            position: relative;
            margin-bottom: 30px;
        }

        .floating-label-group input {
            padding: 10px 10px 10px 0;
            border: 1px solid #ced4da;
            border-radius: 6px;
            width: 150px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .floating-label-group label {
            position: absolute;
            left: 18%;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1em;
            color: #aaa;
            pointer-events: none;
            transition: all 0.2s ease;
        }

        .floating-label-group input:focus + label,
        .floating-label-group input:not(:placeholder-shown) + label {
            top: 0;
            transform: translateY(-70%);
            font-size: 13px;
            font-weight: bold;
            color: #800020;
        }

        .floating-label-target:not(:empty) + .tunai {
            top: 0;
            left: 265px;
            transform: translateY(-75%);
            font-size: 13px;
            font-weight: bold;
            color: #800020;
        }

        .floating-label-target:not(:empty) + .pengeluaran {
            top: 0;
            left: 30px;
            transform: translateY(-70%);
            font-size: 13px;
            font-weight: bold;
            color: #800020;
        }

        .floating-label-target:not(:empty) + .totalbuku {
            top: 0;
            left: 180px;
            transform: translateY(-70%);
            font-size: 13px;
            font-weight: bold;
            color: #800020;
        }

        .floating-label-target:not(:empty) + .selisih {
            top: 0;
            left: 335px;
            transform: translateY(-75%);
            font-size: 13px;
            font-weight: bold;
            color: #800020;
        }

        .floating-label-target:not(:empty) + .jumlah2 {
            top: 0;
            left: 30px;
            transform: translateY(-70%);
            font-size: 13px;
            font-weight: bold;
            color: #800020;
        }

        .floating-label-target:not(:empty) + .qris {
            top: 0;
            left: 180px;
            transform: translateY(-70%);
            font-size: 13px;
            font-weight: bold;
            color: #800020;
        }

        .floating-label-target:not(:empty) + .total {
            top: 0;
            left: 335px;
            transform: translateY(-75%);
            font-size: 13px;
            font-weight: bold;
            color: #800020;
        }

        .tombol-unduh {
            background: green;
        }

        button {
          -webkit-tap-highlight-color: transparent;
        }


    </style>
</head>
<body>
    <header>
        <h1>Bakso Mas Dulla</h1>
        <nav>
            <a href="#" onclick="tampilkanHalaman('kasir')">Data Penjualan</a> |
            <a href="#" onclick="tampilkanHalaman('database')">Data Menu & Harga</a>
        </nav>
        <div class="date-filter">
            <input type="date" id="tanggal-filter" class="date-input">
        </div>
    </header>
    <main>
        <div class="shift-buttons">
            <button onclick="pindahShift(1)" class="shift-button" id="shift1">Shift 1</button>
            <button onclick="pindahShift(2)" class="shift-button" id="shift2">Shift 2</button>
        </div>

            <!-- Tombol Unduh -->
    <button class="tombol-unduh" onclick="unduhData()">Download Laporan Keuangan</button>


        <!-- Halaman Kasir -->
        <section id="kasir">
            <!-- Tombol Filter -->
            <button class="filter-button" onclick="tampilkanSemua()">Semua</button>
            <button class="filter-button" onclick="filterCash()">Total Buku</button>
            <button class="filter-button" onclick="filterCashless()">QRIS | TF | GRAB</button>
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama Item</th>
                        <th>Total</th>
                        <th>Ket</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="riwayat-penjualan">
                    <!-- Data riwayat penjualan akan ditampilkan di sini -->
                </tbody>
            </table>
            <!-- Total Keseluruhan -->
            <div class="total-keseluruhan-container">
                <div class="total-keseluruhan-item" id="total-keseluruhan">
                    Total: Rp 0
                </div>
                <div class="total-keseluruhan-item" id="total-cash">
                    TB: Rp 0
                </div>
                <div class="total-keseluruhan-item" id="total-cashless">
                    QRIS: Rp 0
                </div>
            </div>

            <!-- Tabel Pengeluaran -->
            <div class="pengeluaran-container">
                <h2>Daftar Pengeluaran</h2>
                <table id="tabel-pengeluaran">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Deskripsi</th>
                            <th>Jumlah</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="daftar-pengeluaran">
                        <!-- Data pengeluaran akan ditampilkan di sini -->
                    </tbody>
                </table>
                <div class="total-pengeluaran" id="total-pengeluaran">
                    Total Pengeluaran: Rp 0
                </div>
            </div>

            <!-- Penghitung Item Terjual -->
            <div class="penghitung-item-container" id="penghitung-item">
                <div class="penghitung-item-box">Bakso: <span id="bakso-count">0</span> </div>
                <div class="penghitung-item-box">Pangsit: <span id="pangsit-count">0</span> </div>
                <div class="penghitung-item-box">Ketupat: <span id="ketupat-count">0</span> </div>
                <div class="penghitung-item-box">Bakwan: <span id="bakwan-count">0</span> </div>
                <div class="penghitung-item-box">Kacang: <span id="kacang-count">0</span> </div>
            </div>

            <!-- Penutupan Buku -->
            <div class="penutupan-buku-container">
                <h2>Penutupan Buku</h2>
                <div class="penutupan-buku-row floating-label-group">
                    <input type="text" id="input-uang-tunai" placeholder=" " oninput="formatInput(this)" inputmode="numeric">
                    <label for="input-uang-tunai">Tunai</label>
                    <div> <p>+</p> </div>
                    <span id="total-pengeluaran-display" class="floating-label-target">0</span>
                    <label for="total-pengeluaran-display" class="tunai">Pengeluaran</label>
                </div>

                <div class="penutupan-buku-row floating-label-group">
                    <div> <p>=</p> </div>
                    <span id="jumlah-1" class="floating-label-target">0</span>
                    <label for="jumlah-1" class="pengeluaran">Jumlah</label>
                    <div> <p>-</p> </div>
                    <span id="total-cash-display" class="floating-label-target">0</span>
                    <label for="total-cash-display" class="totalbuku">Total Buku</label>
                    <div> <p>=</p> </div>
                    <span id="selisih" class="floating-label-target">0</span>
                    <label for="jumlah-1" class="selisih">Selisih</label>
                </div>
                <div class="penutupan-buku-row">
                    <div class="penutupan-buku-row floating-label-group">
                        <span id="jumlah-2" class="floating-label-target">0</span>
                        <label for="jumlah-2" class="jumlah2">Jumlah</label>
                        <div> <p>+</p> </div>
                        <span id="total-cashless-display" class="floating-label-target">0</span>
                        <label for="total-cashless-display" class="qris">QRIS</label>
                        <div> <p>=</p> </div>
                        <span id="total-jumlah" class="floating-label-target">0</span>
                        <label for="total-jumlah" class="total">Total</label>
                    </div>
                </div>
            </div>

            <!-- Pop-up Kasir -->
            <div class="overlay" id="overlay"></div>
            <div class="kasir-popup" id="kasir-popup">
                <h2>Kasir</h2>
                <div class="daftar-item-kasir" id="daftar-item-kasir">
                    <!-- Kolom Kiri: Bakso -->
                    <div class="kolom" id="kolom-bakso">
                        <h3>Bakso</h3>
                        <!-- Item Bakso akan ditampilkan di sini -->
                    </div>
                    <!-- Kolom Tengah: Pangsit & Biji -->
                    <div class="kolom" id="kolom-pangsit-biji">
                        <h3>Pangsit & Biji</h3>
                        <!-- Item Pangsit dan Biji akan ditampilkan di sini -->
                    </div>
                    <!-- Kolom Kanan: Lainnya -->
                    <div class="kolom" id="kolom-lainnya">
                        <h3>Lainnya</h3>
                        <!-- Item lainnya akan ditampilkan di sini -->
                    </div>
                </div>
                <h3>Daftar Belanja</h3>
                <div class="daftar-belanja">
                    <table>
                        <thead>
                            <tr>
                                <th>Nama Item</th>
                                <th>Jumlah</th>
                                <th>Harga Satuan</th>
                                <th>Total</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-belanja">
                            <!-- Daftar belanja akan ditampilkan di sini -->
                        </tbody>
                    </table>
                </div>
                <div class="total-bayar" id="total-bayar">
                    Total Bayar: Rp 0
                </div>
                <div class="pembayaran">
                    <input type="text" id="uang-pembayaran" placeholder="Uang Pembayaran (Rp)" oninput="formatInput(this)" inputmode="numeric">
                    <div id="grab-total-harga" style="display: none;">
                        <input type="text" id="total-harga-grab" placeholder="Total Harga GRAB (Rp)" oninput="formatInput(this)" inputmode="numeric">
                    </div>
                    <button onclick="hitungKembalian()" class="filter-button">Hitung Kembalian</button>
                </div>
                <div class="kembalian" id="kembalian">
                    Kembalian: Rp 0
                </div>
                <div class="metode-pembayaran">
                    <button onclick="pilihMetodePembayaran('CASH')">CASH</button>
                    <button onclick="pilihMetodePembayaran('QRIS')">QRIS</button>
                    <button onclick="pilihMetodePembayaran('TF')">TF</button>
                    <button onclick="pilihMetodePembayaran('GRAB')">GRAB</button>
                </div>
                <button onclick="simpanTransaksi()" class="filter-button" style="background: #218000;">Simpan Transaksi</button>
                <button onclick="tutupKasir()" class="batalkan-perubahan" id="tutup-button">Tutup</button>
                <button class="batalkan-perubahan" id="batalkan-perubahan" onclick="batalkanPerubahan()" style="display: none;">Batalkan Perubahan</button>
            </div>
        </section>

        <!-- Halaman Kelola Item & Harga -->
        <section id="database" style="display: none;">
            <h2>Tambah Item</h2>
            <form id="form-item">
                <input type="text" id="nama-item" placeholder="Nama Item" required>
                <input type="text" id="harga-item" placeholder="Harga (Rp)" oninput="formatInput(this)" inputmode="numeric" required>
                <button type="submit" class="filter-button">Tambahkan</button>
            </form>
            <h2>Daftar Item</h2>
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama Item</th>
                        <th>Harga</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="daftar-item">
                    <!-- Data item akan ditampilkan di sini -->
                </tbody>
            </table>
        </section>
    </main>

    <!-- Tombol Input Pengeluaran -->
    <button class="tombol-pengeluaran" onclick="bukaFormPengeluaran()">ðŸ’µ</button>

    <!-- Tombol Keranjang -->
    <button class="tombol-keranjang" onclick="bukaKasir()">ðŸ›’</button>

    <!-- Form Pengeluaran -->
    <div class="overlay" id="overlay-pengeluaran"></div>
    <div class="form-pengeluaran-popup" id="form-pengeluaran-popup">
        <h2>Tambah Pengeluaran</h2>
        <form id="form-pengeluaran">
            <input type="text" id="deskripsi-pengeluaran" placeholder="Deskripsi Pengeluaran" required>
            <input type="text" id="jumlah-pengeluaran" placeholder="Jumlah (Rp)" oninput="formatInput(this)" inputmode="numeric" required>
            <button type="submit" class="filter-button">Simpan</button>
            <button type="button" class="batalkan-perubahan" onclick="tutupFormPengeluaran()">Batal</button>
        </form>
    </div>

    <script>
document.addEventListener("DOMContentLoaded", function () {
    // Ambil nilai shiftAktif dari local storage
    let savedShift = localStorage.getItem("shiftAktif");
    if (savedShift) {
        shiftAktif = parseInt(savedShift, 10);
    } else {
        shiftAktif = 1; // Default ke Shift 1 jika tidak ada nilai yang disimpan
    }

    pindahShift(shiftAktif); // Gunakan nilai shiftAktif yang diambil dari local storage
    tampilkanSemua();
    loadItems();
    setupForm();
    loadPengeluaran();
    setupFormPengeluaran();
    loadInputUangTunai(); // Muat nilai input-uang-tunai saat halaman dimuat
    loadTanggalFilter(); // Muat tanggal filter saat halaman dimuat

    // Tambahkan event listener untuk memfilter data secara otomatis saat tanggal dipilih
    document.getElementById("tanggal-filter").addEventListener("change", function () {
        filterTanggal();
    });
});

        function loadTanggalFilter() {
            let tanggalInput = document.getElementById("tanggal-filter");
            tanggalFilter = localStorage.getItem("tanggalFilter") || "";
            if (tanggalFilter) {
                tanggalInput.value = tanggalFilter;
                filterTanggal();
            }
        }

        function filterTanggal() {
            let tanggalInput = document.getElementById("tanggal-filter").value;
            tanggalFilter = tanggalInput;
            localStorage.setItem("tanggalFilter", tanggalFilter);
            tampilkanSemua();
            loadPengeluaran();
            loadInputUangTunai(); // Load the value of input-uang-tunai based on the selected date
            updatePenutupanBuku();
        }

        function loadInputUangTunai() {
            let inputUangTunai = document.getElementById("input-uang-tunai");
            let tanggal = tanggalFilter || new Date().toISOString().split('T')[0];
            let nilaiUangTunai = localStorage.getItem(`inputUangTunaiShift${shiftAktif}_${tanggal}`) || "0";
            inputUangTunai.value = formatRupiah(nilaiUangTunai);
        }

        function saveInputUangTunai() {
            let inputUangTunai = document.getElementById("input-uang-tunai");
            let nilaiUangTunai = hapusPemisahRibuan(inputUangTunai.value);
            let tanggal = tanggalFilter || new Date().toISOString().split('T')[0];
            localStorage.setItem(`inputUangTunaiShift${shiftAktif}_${tanggal}`, nilaiUangTunai);
        }

function pindahShift(shift) {
    shiftAktif = shift;
    localStorage.setItem("shiftAktif", shiftAktif); // Simpan nilai shiftAktif ke local storage
    document.querySelectorAll('.shift-button').forEach(button => {
        button.classList.remove('active');
    });
    document.getElementById(`shift${shift}`).classList.add('active');
    tampilkanSemua();
    loadPengeluaran();
    loadInputUangTunai(); // Load the value of input-uang-tunai based on the selected date
        updatePenutupanBuku(); // Perbarui penutupan buku setiap kali shift diubah

}

        document.getElementById("input-uang-tunai").addEventListener("input", function() {
            formatInput(this);
            saveInputUangTunai(); // Simpan nilai input-uang-tunai saat diubah
            updatePenutupanBuku();
        });

        function formatRupiah(angka) {
            return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function hapusPemisahRibuan(angka) {
            return angka.replace(/\./g, "");
        }

        function formatInput(input) {
            let nilai = input.value;
            let nilaiTanpaPemisah = hapusPemisahRibuan(nilai);
            if (!isNaN(nilaiTanpaPemisah)) {
                input.value = formatRupiah(nilaiTanpaPemisah);
            } else {
                input.value = "";
            }
        }

        let metodePembayaranTerpilih = "";
        let indexTransaksiEdit = null;
        let shiftAktif = 1;
        let tanggalFilter = "";

        function pilihMetodePembayaran(metode) {
            metodePembayaranTerpilih = metode;
            toggleActiveButton(metode);
            toggleGrabInput(metode);
        }

        function toggleActiveButton(metode) {
            document.querySelectorAll('.metode-pembayaran button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.metode-pembayaran button[onclick="pilihMetodePembayaran('${metode}')"]`).classList.add('active');
        }

        function toggleGrabInput(metode) {
            document.getElementById("grab-total-harga").style.display = metode === "GRAB" ? "block" : "none";
        }

        function tampilkanRiwayat(filter = null) {
            let riwayat = JSON.parse(localStorage.getItem(`riwayatPenjualanShift${shiftAktif}`)) || [];
            riwayat = riwayat.filter(item => !tanggalFilter || item.tanggal === tanggalFilter);

            let riwayatPenjualan = document.getElementById("riwayat-penjualan");
            let totalKeseluruhan = 0;
            let totalCash = 0;
            let totalCashless = 0;

            riwayatPenjualan.innerHTML = "";

            if (filter) {
                riwayat = riwayat.filter(item => filter === "CASH" ? item.keterangan === "CASH" : item.keterangan !== "CASH");
            }

            riwayat.forEach((item, index) => {
                totalKeseluruhan += item.total;
                if (item.keterangan === "CASH") {
                    totalCash += item.total;
                } else {
                    totalCashless += item.total;
                }
                let namaItem = item.nama.split(", ").join("<br>");
                let row = createRow(index, namaItem, item.total, item.keterangan, item.lunas);
                riwayatPenjualan.innerHTML += row;
            });

            document.getElementById("total-keseluruhan").innerText = `Total : Rp ${formatRupiah(totalKeseluruhan)}`;
            document.getElementById("total-cash").innerText = `TB: Rp ${formatRupiah(totalCash)}`;
            document.getElementById("total-cashless").innerText = `QRIS: Rp ${formatRupiah(totalCashless)}`;
            hitungItemTerjual(riwayat);
            updatePenutupanBuku();
        }

        function createRow(index, namaItem, total, keterangan, lunas) {
            return `<tr class="${lunas ? 'lunas' : ''}">
                <td>${index + 1}</td>
                <td>${namaItem}</td>
                <td>Rp ${formatRupiah(total)}</td>
                <td>${keterangan}</td>
                <td>
                    <div class="tombol-aksi">
                        <button style="background: green;" onclick="tandaiLunas(${index})" class="filter-button">Lunas</button>
                        <button style="background: #05479b;" onclick="editTransaksi(${index})" class="filter-button">Edit</button>
                        <button onclick="hapusTransaksi(${index})" class="batalkan-perubahan">Hapus</button>
                    </div>
                </td>
            </tr>`;
        }

function tandaiLunas(index) {
    let riwayat = JSON.parse(localStorage.getItem(`riwayatPenjualanShift${shiftAktif}`)) || [];
    riwayat[index].lunas = true;
    localStorage.setItem(`riwayatPenjualanShift${shiftAktif}`, JSON.stringify(riwayat));

    let row = document.querySelector(`#riwayat-penjualan tr:nth-child(${index + 1})`);
    if (row) {
        row.classList.add('lunas');
    }

    // Hapus atau komentari baris berikut untuk menghilangkan notifikasi
    // Swal.fire({
    //     icon: 'success',
    //     title: 'Berhasil',
    //     text: 'Transaksi telah ditandai sebagai lunas!',
    // });
}


        function hitungItemTerjual(riwayat) {
            let penghitung = { Bakso: 0, Pangsit: 0, Ketupat: 0, Bakwan: 0, Kacang: 0 };

            // Filter transactions by the selected date
            riwayat = riwayat.filter(item => !tanggalFilter || item.tanggal === tanggalFilter);

            riwayat.forEach((transaksi) => {
                transaksi.nama.split(", ").forEach((item) => {
                    let [jumlah, ...nama] = item.split(" ");
                    let namaItem = nama.join(" ");
                    if (namaItem.toLowerCase().includes("bakso")) penghitung.Bakso += parseInt(jumlah);
                    if (namaItem.toLowerCase().includes("pangsit")) penghitung.Pangsit += parseInt(jumlah);
                    if (namaItem.toLowerCase().includes("ketupat")) penghitung.Ketupat += parseInt(jumlah);
                    if (namaItem.toLowerCase().includes("bakwan")) penghitung.Bakwan += parseInt(jumlah);
                    if (namaItem.toLowerCase().includes("kacang")) penghitung.Kacang += parseInt(jumlah);
                });
            });

            updatePenghitungItem(penghitung);
        }

        function updatePenghitungItem(penghitung) {
            document.getElementById("bakso-count").innerText = penghitung.Bakso;
            document.getElementById("pangsit-count").innerText = penghitung.Pangsit;
            document.getElementById("ketupat-count").innerText = penghitung.Ketupat;
            document.getElementById("bakwan-count").innerText = penghitung.Bakwan;
            document.getElementById("kacang-count").innerText = penghitung.Kacang;
        }

        function tampilkanSemua() {
            tampilkanRiwayat();
        }

        function filterCash() {
            tampilkanRiwayat("CASH");
        }

        function filterCashless() {
            tampilkanRiwayat("CASHLESS");
        }

        function loadItems() {
            let daftar = JSON.parse(localStorage.getItem("daftarItem")) || [];
            let daftarItem = document.getElementById("daftar-item");

            daftarItem.innerHTML = "";
            daftar.forEach((item, index) => {
                let row = `<tr>
                    <td>${index + 1}</td>
                    <td>${item.nama}</td>
                    <td>Rp ${formatRupiah(item.harga)}</td>
                    <td>
                        <div class="tombol-aksi">
                            <button onclick="hapusItem(${index})" class="batalkan-perubahan">Hapus</button>
                        </div>
                    </td>
                </tr>`;
                daftarItem.innerHTML += row;
            });
        }

        function setupForm() {
            let formItem = document.getElementById("form-item");
            formItem.addEventListener("submit", function (e) {
                e.preventDefault();
                let nama = document.getElementById("nama-item").value;
                let harga = hapusPemisahRibuan(document.getElementById("harga-item").value);

                let daftar = JSON.parse(localStorage.getItem("daftarItem")) || [];
                daftar.push({ nama, harga });
                localStorage.setItem("daftarItem", JSON.stringify(daftar));

                loadItems();
                formItem.reset();

                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil',
                    text: 'Item telah ditambahkan!',
                });
            });
        }

        function tampilkanHalaman(halaman) {
            document.getElementById("kasir").style.display = halaman === 'kasir' ? "block" : "none";
            document.getElementById("database").style.display = halaman === 'database' ? "block" : "none";
        }

        function bukaKasir() {
            document.getElementById("overlay").style.display = "block";
            document.getElementById("kasir-popup").style.display = "block";
            document.body.classList.add("no-scroll"); // Tambahkan kelas untuk mencegah scrolling

            let daftar = JSON.parse(localStorage.getItem("daftarItem")) || [];
            let daftarItemKasir = document.getElementById("daftar-item-kasir");

            resetKolom();
            tampilkanItemKasir(daftar);
            perbaruiDaftarBelanja();

            if (indexTransaksiEdit !== null) {
                document.querySelector("#kasir-popup button[onclick='tutupKasir()']").style.display = "none";
                document.getElementById("batalkan-perubahan").style.display = "inline-block";
            } else {
                document.querySelector("#kasir-popup button[onclick='tutupKasir()']").style.display = "inline-block";
                document.getElementById("batalkan-perubahan").style.display = "none";
            }
        }

        function resetKolom() {
            document.getElementById("kolom-bakso").innerHTML = "<h3>Bakso</h3>";
            document.getElementById("kolom-pangsit-biji").innerHTML = "<h3>Pangsit & Biji</h3>";
            document.getElementById("kolom-lainnya").innerHTML = "<h3>Lainnya</h3>";
        }

        function tampilkanItemKasir(daftar) {
            daftar.forEach((item) => {
                let button = `<button class="item-button" onclick="tambahKeBelanja('${item.nama}', ${item.harga})">${item.nama} - Rp ${formatRupiah(item.harga)}</button>`;
                if (item.nama.toLowerCase().includes("bakso")) {
                    document.getElementById("kolom-bakso").innerHTML += button;
                } else if (item.nama.toLowerCase().includes("pangsit") || item.nama.toLowerCase().includes("biji")) {
                    document.getElementById("kolom-pangsit-biji").innerHTML += button;
                } else {
                    document.getElementById("kolom-lainnya").innerHTML += button;
                }
            });
        }

        function tutupKasir() {
            localStorage.removeItem("belanja");
            perbaruiDaftarBelanja();

            document.getElementById("overlay").style.display = "none";
            document.getElementById("kasir-popup").style.display = "none";
            document.body.classList.remove("no-scroll"); // Hapus kelas untuk mengaktifkan kembali scrolling
        }

        function tambahKeBelanja(nama, harga) {
            let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
            let item = belanja.find((item) => item.nama === nama);

            if (item) {
                item.jumlah += 1;
            } else {
                belanja.push({ nama, harga, jumlah: 1 });
            }

            localStorage.setItem("belanja", JSON.stringify(belanja));
            perbaruiDaftarBelanja();
        }

        function perbaruiDaftarBelanja() {
            let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
            let daftarBelanja = document.getElementById("daftar-belanja");
            let totalBayar = 0;

            let belanjaGabung = gabungItem(belanja);
            daftarBelanja.innerHTML = "";

            belanjaGabung.forEach((item) => {
                let totalHarga = item.harga * item.jumlah;
                totalBayar += totalHarga;
                let row = createBelanjaRow(item, totalHarga);
                daftarBelanja.innerHTML += row;
            });

            document.getElementById("total-bayar").innerText = `Total Bayar: Rp ${formatRupiah(totalBayar)}`;
            updateTutupButton(belanja.length);
        }

        function gabungItem(belanja) {
            let belanjaGabung = [];
            belanja.forEach((item) => {
                let itemExist = belanjaGabung.find((i) => i.nama === item.nama);
                if (itemExist) {
                    itemExist.jumlah += item.jumlah;
                } else {
                    belanjaGabung.push({ ...item });
                }
            });
            return belanjaGabung;
        }

        function createBelanjaRow(item, totalHarga) {
            return `<tr>
                <td>${item.nama}</td>
                <td>${item.jumlah}</td>
                <td>Rp ${formatRupiah(item.harga)}</td>
                <td>Rp ${formatRupiah(totalHarga)}</td>
                <td>
                    <div class="tombol-aksi">
                        <button onclick="hapusDariBelanja('${item.nama}')" class="batalkan-perubahan">Hapus</button>
                    </div>
                </td>
            </tr>`;
        }

        function updateTutupButton(length) {
            let tombolTutup = document.querySelector("#kasir-popup button[onclick='tutupKasir()']");
            if (length > 0) {
                tombolTutup.classList.add("tutup-merah");
            } else {
                tombolTutup.classList.remove("tutup-merah");
            }
        }

        function hapusDariBelanja(nama) {
            let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
            belanja = belanja.filter((item) => item.nama !== nama);
            localStorage.setItem("belanja", JSON.stringify(belanja));
            perbaruiDaftarBelanja();
        }

        function hitungKembalian() {
            let totalBayar = parseFloat(hapusPemisahRibuan(document.getElementById("total-bayar").innerText.replace("Total Bayar: Rp ", "")));
            let uangPembayaran = parseFloat(hapusPemisahRibuan(document.getElementById("uang-pembayaran").value));

            if (isNaN(uangPembayaran)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Kesalahan',
                    text: 'Masukkan jumlah uang pembayaran!',
                });
                return;
            }

            if (uangPembayaran < totalBayar) {
                Swal.fire({
                    icon: 'error',
                    title: 'Kesalahan',
                    text: 'Uang pembayaran tidak cukup!',
                });
                return;
            }

            let kembalian = uangPembayaran - totalBayar;
            document.getElementById("kembalian").innerText = `Kembalian: Rp ${formatRupiah(kembalian)}`;
        }

        function simpanTransaksi() {
            let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
            if (belanja.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Kesalahan',
                    text: 'Belanjaan kosong!',
                });
                return;
            }

            let riwayat = JSON.parse(localStorage.getItem(`riwayatPenjualanShift${shiftAktif}`)) || [];
            let totalBayar = belanja.reduce((total, item) => total + item.harga * item.jumlah, 0);

            if (metodePembayaranTerpilih === "GRAB") {
                let totalHargaGrab = hapusPemisahRibuan(document.getElementById("total-harga-grab").value);
                if (!totalHargaGrab || isNaN(totalHargaGrab)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Kesalahan',
                        text: 'Masukkan total harga GRAB yang valid!',
                    });
                    return;
                }
                totalBayar = parseFloat(totalHargaGrab);
            }

            let namaItem = belanja.map(item => `${item.jumlah} ${item.nama}`).join(", ");
            let transaksi = {
                nama: namaItem,
                jumlah: belanja.reduce((total, item) => total + item.jumlah, 0),
                total: totalBayar,
                keterangan: metodePembayaranTerpilih || "CASH",
                lunas: false,
                tanggal: tanggalFilter || new Date().toISOString().split('T')[0]
            };

            if (indexTransaksiEdit !== null) {
                riwayat[indexTransaksiEdit] = transaksi;
                indexTransaksiEdit = null;
            } else {
                riwayat.push(transaksi);
            }

            localStorage.setItem(`riwayatPenjualanShift${shiftAktif}`, JSON.stringify(riwayat));
            localStorage.removeItem("belanja");
            metodePembayaranTerpilih = "";
            tutupKasir();

            tampilkanSemua();
            hitungItemTerjual(riwayat);

            Swal.fire({
                icon: 'success',
                title: 'Berhasil',
                text: 'Transaksi telah disimpan!',
            });
        }

        function hapusItem(index) {
            Swal.fire({
                title: 'Masukkan PIN',
                input: 'number',
                inputAttributes: {
                    autocapitalize: 'off',
                    inputmode: 'numeric'
                },
                showCancelButton: true,
                confirmButtonText: 'Hapus',
                showLoaderOnConfirm: true,
                preConfirm: (pin) => {
                    if (pin !== "0000") {
                        Swal.showValidationMessage(`PIN salah! Penghapusan dibatalkan.`);
                    }
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    let daftar = JSON.parse(localStorage.getItem("daftarItem")) || [];
                    daftar.splice(index, 1);
                    localStorage.setItem("daftarItem", JSON.stringify(daftar));

                    loadItems();

                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil',
                        text: 'Item telah dihapus!',
                    });
                }
            });
        }

        function hapusTransaksi(index) {
            Swal.fire({
                title: 'Masukkan PIN',
                input: 'number',
                inputAttributes: {
                    autocapitalize: 'off',
                    inputmode: 'numeric'
                },
                showCancelButton: true,
                confirmButtonText: 'Hapus',
                showLoaderOnConfirm: true,
                preConfirm: (pin) => {
                    if (pin !== "0000") {
                        Swal.showValidationMessage(`PIN salah! Penghapusan dibatalkan.`);
                    }
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    let riwayat = JSON.parse(localStorage.getItem(`riwayatPenjualanShift${shiftAktif}`)) || [];
                    riwayat.splice(index, 1);
                    localStorage.setItem(`riwayatPenjualanShift${shiftAktif}`, JSON.stringify(riwayat));

                    tampilkanSemua();

                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil',
                        text: 'Transaksi telah dihapus!',
                    });
                }
            });
        }

        function editTransaksi(index) {
            let riwayat = JSON.parse(localStorage.getItem(`riwayatPenjualanShift${shiftAktif}`)) || [];
            let transaksi = riwayat[index];
            indexTransaksiEdit = index;

            let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
            transaksi.nama.split(", ").forEach((item) => {
                let [jumlah, ...nama] = item.split(" ");
                let namaItem = nama.join(" ");
                let harga = JSON.parse(localStorage.getItem("daftarItem")).find((item) => item.nama === namaItem).harga;
                belanja.push({ nama: namaItem, harga, jumlah: parseInt(jumlah) });
            });

            localStorage.setItem("belanja", JSON.stringify(belanja));
            pilihMetodePembayaran(transaksi.keterangan);

            if (transaksi.keterangan === "GRAB") {
                document.getElementById("total-harga-grab").value = formatRupiah(transaksi.total);
            }

            document.getElementById("batalkan-perubahan").style.display = "inline-block";
            document.querySelector("#kasir-popup button[onclick='tutupKasir()']").style.display = "none";
            bukaKasir();
        }

        function batalkanPerubahan() {
            indexTransaksiEdit = null;
            localStorage.removeItem("belanja");
            document.getElementById("batalkan-perubahan").style.display = "none";
            document.querySelector("#kasir-popup button[onclick='tutupKasir()']").style.display = "inline-block";
            tutupKasir();
        }

        function loadPengeluaran() {
            let daftarPengeluaran = JSON.parse(localStorage.getItem(`daftarPengeluaranShift${shiftAktif}`)) || [];
            daftarPengeluaran = daftarPengeluaran.filter(item => !tanggalFilter || item.tanggal === tanggalFilter);

            let tabelPengeluaran = document.getElementById("daftar-pengeluaran");

            tabelPengeluaran.innerHTML = "";
            daftarPengeluaran.forEach((item, index) => {
                let row = `<tr>
                    <td>${index + 1}</td>
                    <td>${item.deskripsi}</td>
                    <td>Rp ${formatRupiah(item.jumlah)}</td>
                    <td>
                        <button onclick="hapusPengeluaran(${index})" class="batalkan-perubahan">Hapus</button>
                    </td>
                </tr>`;
                tabelPengeluaran.innerHTML += row;
            });

            hitungTotalPengeluaran();
        }

function hitungTotalPengeluaran() {
    let daftarPengeluaran = JSON.parse(localStorage.getItem(`daftarPengeluaranShift${shiftAktif}`)) || [];
    daftarPengeluaran = daftarPengeluaran.filter(item => !tanggalFilter || item.tanggal === tanggalFilter);

    let totalPengeluaran = daftarPengeluaran.reduce((total, item) => total + parseInt(item.jumlah), 0);
    document.getElementById("total-pengeluaran").innerText = `Total Pengeluaran: Rp ${formatRupiah(totalPengeluaran)}`;
    updatePenutupanBuku();
}


        function setupFormPengeluaran() {
            let formPengeluaran = document.getElementById("form-pengeluaran");
            formPengeluaran.addEventListener("submit", function (e) {
                e.preventDefault();
                let deskripsi = document.getElementById("deskripsi-pengeluaran").value;
                let jumlah = hapusPemisahRibuan(document.getElementById("jumlah-pengeluaran").value);

                let daftarPengeluaran = JSON.parse(localStorage.getItem(`daftarPengeluaranShift${shiftAktif}`)) || [];
                daftarPengeluaran.push({ deskripsi, jumlah, tanggal: tanggalFilter || new Date().toISOString().split('T')[0] });
                localStorage.setItem(`daftarPengeluaranShift${shiftAktif}`, JSON.stringify(daftarPengeluaran));

                loadPengeluaran();
                formPengeluaran.reset();
                tutupFormPengeluaran();

                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil',
                    text: 'Pengeluaran telah ditambahkan!',
                });
            });
        }

        function bukaFormPengeluaran() {
            document.getElementById("overlay-pengeluaran").style.display = "block";
            document.getElementById("form-pengeluaran-popup").style.display = "block";
            document.body.classList.add("no-scroll");
        }

        function tutupFormPengeluaran() {
            document.getElementById("overlay-pengeluaran").style.display = "none";
            document.getElementById("form-pengeluaran-popup").style.display = "none";
            document.body.classList.remove("no-scroll");
        }

        function hapusPengeluaran(index) {
            Swal.fire({
                title: 'Masukkan PIN',
                input: 'number',
                inputAttributes: {
                    autocapitalize: 'off',
                    inputmode: 'numeric'
                },
                showCancelButton: true,
                confirmButtonText: 'Hapus',
                showLoaderOnConfirm: true,
                preConfirm: (pin) => {
                    if (pin !== "0000") {
                        Swal.showValidationMessage(`PIN salah! Penghapusan dibatalkan.`);
                    }
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    let daftarPengeluaran = JSON.parse(localStorage.getItem(`daftarPengeluaranShift${shiftAktif}`)) || [];
                    daftarPengeluaran.splice(index, 1);
                    localStorage.setItem(`daftarPengeluaranShift${shiftAktif}`, JSON.stringify(daftarPengeluaran));

                    loadPengeluaran();

                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil',
                        text: 'Pengeluaran telah dihapus!',
                    });
                }
            });
        }

        function updatePenutupanBuku() {
            let inputUangTunai = parseFloat(hapusPemisahRibuan(document.getElementById("input-uang-tunai").value)) || 0;
            let totalPengeluaran = parseFloat(hapusPemisahRibuan(document.getElementById("total-pengeluaran").innerText.replace("Total Pengeluaran: Rp ", ""))) || 0;
            let totalCash = parseFloat(hapusPemisahRibuan(document.getElementById("total-cash").innerText.replace("TB: Rp ", ""))) || 0;
            let totalCashless = parseFloat(hapusPemisahRibuan(document.getElementById("total-cashless").innerText.replace("QRIS: Rp ", ""))) || 0;

            let jumlah1 = inputUangTunai + totalPengeluaran;
            let totalCashDisplay = totalCash; // Pastikan totalCashDisplay dihitung dengan benar
            let selisih = jumlah1 - totalCashDisplay; // Gunakan totalCashDisplay dalam perhitungan selisih
            let jumlah2 = jumlah1 + totalCashless;

            document.getElementById("total-pengeluaran-display").innerText = formatRupiah(totalPengeluaran);
            document.getElementById("total-cash-display").innerText = formatRupiah(totalCashDisplay);
            document.getElementById("total-cashless-display").innerText = formatRupiah(totalCashless);
            document.getElementById("jumlah-1").innerText = formatRupiah(jumlah1);
            document.getElementById("jumlah-2").innerText = formatRupiah(jumlah1);
            document.getElementById("total-jumlah").innerText = formatRupiah(jumlah2);
            document.getElementById("selisih").innerText = formatRupiah(selisih); // Tampilkan selisih
        }

        // Panggil fungsi ini setiap kali ada perubahan pada input atau nilai-nilai lain yang relevan
        document.getElementById("input-uang-tunai").addEventListener("input", updatePenutupanBuku);
        document.getElementById("total-pengeluaran").addEventListener("DOMSubtreeModified", updatePenutupanBuku);
        document.getElementById("total-cash").addEventListener("DOMSubtreeModified", updatePenutupanBuku);
        document.getElementById("total-cashless").addEventListener("DOMSubtreeModified", updatePenutupanBuku);

function unduhData() {
    try {
        // Ambil tanggal yang dipilih atau tanggal hari ini
        let tanggal = document.getElementById("tanggal-filter").value || new Date().toISOString().split('T')[0];
        let sheetAktif = shiftAktif === 1 ? "Shift1" : "Shift2";

        // Ambil data riwayat penjualan dan pengeluaran dari Local Storage
        let riwayat = JSON.parse(localStorage.getItem(`riwayatPenjualanShift${shiftAktif}`)) || [];
        let daftarPengeluaran = JSON.parse(localStorage.getItem(`daftarPengeluaranShift${shiftAktif}`)) || [];

        // Filter data berdasarkan tanggal yang dipilih
        riwayat = riwayat.filter(item => !tanggal || item.tanggal === tanggal);
        daftarPengeluaran = daftarPengeluaran.filter(item => !tanggal || item.tanggal === tanggal);

        // Hitung jumlah item yang terjual
        let penghitung = { Bakso: 0, Pangsit: 0, Ketupat: 0, Bakwan: 0, Kacang: 0 };
        riwayat.forEach((transaksi) => {
            transaksi.nama.split(", ").forEach((item) => {
                let [jumlah, ...nama] = item.split(" ");
                let namaItem = nama.join(" ");
                if (namaItem.toLowerCase().includes("bakso")) penghitung.Bakso += parseInt(jumlah) || 0;
                if (namaItem.toLowerCase().includes("pangsit")) penghitung.Pangsit += parseInt(jumlah) || 0;
                if (namaItem.toLowerCase().includes("ketupat")) penghitung.Ketupat += parseInt(jumlah) || 0;
                if (namaItem.toLowerCase().includes("bakwan")) penghitung.Bakwan += parseInt(jumlah) || 0;
                if (namaItem.toLowerCase().includes("kacang")) penghitung.Kacang += parseInt(jumlah) || 0;
            });
        });

        // Ambil dan hitung data penutupan buku
        let inputUangTunai = parseFloat(hapusPemisahRibuan(document.getElementById("input-uang-tunai").value)) || 0;
        let totalPengeluaran = parseFloat(hapusPemisahRibuan(document.getElementById("total-pengeluaran").innerText.replace("Total Pengeluaran: Rp ", ""))) || 0;
        let totalCash = parseFloat(hapusPemisahRibuan(document.getElementById("total-cash").innerText.replace("TB: Rp ", ""))) || 0;
        let totalCashless = parseFloat(hapusPemisahRibuan(document.getElementById("total-cashless").innerText.replace("QRIS: Rp ", ""))) || 0;

        let jumlah1 = inputUangTunai + totalPengeluaran;
        let selisih = jumlah1 - totalCash;
        let jumlah2 = jumlah1 + totalCashless;

        let penutupanBuku = {
            "Tunai": inputUangTunai,
            "Pengeluaran": totalPengeluaran,
            "Jumlah": jumlah1,
            "Total Buku": totalCash,
            "Selisih": selisih,
            "QRIS": totalCashless,
            "Total": jumlah2,
        };

        // Buat workbook dan tambahkan lembar kerja
        let wb = XLSX.utils.book_new();

        // Tambahkan riwayat penjualan
        let wsRiwayat = XLSX.utils.json_to_sheet(riwayat);
        XLSX.utils.book_append_sheet(wb, wsRiwayat, "RiwayatPenjualan");

        // Tambahkan daftar pengeluaran
        let wsPengeluaran = XLSX.utils.json_to_sheet(daftarPengeluaran);
        XLSX.utils.book_append_sheet(wb, wsPengeluaran, "DaftarPengeluaran");

        // Tambahkan penghitung item
        let wsPenghitung = XLSX.utils.json_to_sheet([penghitung]);
        XLSX.utils.book_append_sheet(wb, wsPenghitung, "PenghitungBakso");

        // Tambahkan data penutupan buku
        let wsPenutupanBuku = XLSX.utils.json_to_sheet([penutupanBuku]);
        XLSX.utils.book_append_sheet(wb, wsPenutupanBuku, "PenutupanBuku");

        // Tentukan nama file
        let fileName = `${tanggal}_${sheetAktif}.xlsx`;

        // Ekspor workbook menjadi file Excel
        XLSX.writeFile(wb, fileName);

    } catch (error) {
        console.error("Terjadi kesalahan saat mengunduh data:", error);
        alert("Terjadi kesalahan saat mengunduh data. Silakan coba lagi.");
    }
}

    </script>
</body>
</html>
