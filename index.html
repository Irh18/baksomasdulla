<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir</title>
    <style>
        /* CSS sebelumnya tetap sama */
        .lunas {
            background-color: #4CAF50; /* Latar belakang hijau */
            color: white; /* Tulisan putih */
            padding: 5px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<!-- Bagian HTML sebelumnya tetap sama -->

<script>
    // Fungsi untuk memformat angka dengan pemisah ribuan (titik)
    function formatRupiah(angka) {
        return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // Fungsi untuk menghapus pemisah ribuan (titik) dan mengembalikan angka biasa
    function hapusPemisahRibuan(angka) {
        return angka.replace(/\./g, "");
    }

    // Fungsi untuk memformat input saat pengguna mengetik
    function formatInput(input) {
        let nilai = input.value;
        let nilaiTanpaPemisah = hapusPemisahRibuan(nilai);
        if (!isNaN(nilaiTanpaPemisah)) {
            input.value = formatRupiah(nilaiTanpaPemisah);
        } else {
            input.value = ""; // Reset jika input tidak valid
        }
    }

    let metodePembayaranTerpilih = "";
    let indexTransaksiEdit = null; // Menyimpan indeks transaksi yang sedang diedit

    function pilihMetodePembayaran(metode) {
        metodePembayaranTerpilih = metode;
        // Hapus kelas active dari semua tombol
        document.querySelectorAll('.metode-pembayaran button').forEach(button => {
            button.classList.remove('active');
        });
        // Tambahkan kelas active ke tombol yang dipilih
        document.querySelector(`.metode-pembayaran button[onclick="pilihMetodePembayaran('${metode}')"]`).classList.add('active');

        // Tampilkan input total harga GRAB jika metode pembayaran adalah GRAB
        if (metode === "GRAB") {
            document.getElementById("grab-total-harga").style.display = "block";
        } else {
            document.getElementById("grab-total-harga").style.display = "none";
        }
    }

    function tampilkanRiwayat(filter = null) {
        let riwayat = JSON.parse(localStorage.getItem("riwayatPenjualan")) || [];
        let riwayatPenjualan = document.getElementById("riwayat-penjualan");
        let totalKeseluruhan = 0;

        // Kosongkan tabel riwayat penjualan
        riwayatPenjualan.innerHTML = "";

        // Filter data berdasarkan metode pembayaran
        if (filter === "CASH") {
            riwayat = riwayat.filter(item => item.keterangan === "CASH");
        } else if (filter === "CASHLESS") {
            riwayat = riwayat.filter(item => item.keterangan !== "CASH");
        }

        // Tampilkan riwayat penjualan
        riwayat.forEach((item, index) => {
            totalKeseluruhan += item.total;
            let row = `<tr>
                <td>${index + 1}</td>
                <td>${item.nama}</td>
                <td>${item.jumlah}</td>
                <td class="${item.lunas ? 'lunas' : ''}">Rp ${formatRupiah(item.total)}</td>
                <td>${item.keterangan}</td>
                <td>
                    <button onclick="tandaiLunas(${index})" class="filter-button">Lunas</button>
                    <button onclick="editTransaksi(${index})" class="filter-button">Edit</button>
                    <button onclick="hapusTransaksi(${index})" class="batalkan-perubahan">Hapus</button>
                </td>
            </tr>`;
            riwayatPenjualan.innerHTML += row;
        });

        // Tampilkan total keseluruhan
        document.getElementById("total-keseluruhan").innerText = `Total Keseluruhan: Rp ${formatRupiah(totalKeseluruhan)}`;

        // Hitung dan tampilkan penghitung item terjual
        hitungItemTerjual(riwayat);
    }

    function hitungItemTerjual(riwayat) {
        let penghitung = {
            Bakso: 0,
            Pangsit: 0,
        };

        riwayat.forEach((transaksi) => {
            transaksi.nama.split(", ").forEach((item) => {
                let [jumlah, ...nama] = item.split(" ");
                let namaItem = nama.join(" ");

                // Hitung Bakso
                if (namaItem.toLowerCase().includes("bakso")) {
                    penghitung.Bakso += parseInt(jumlah);
                }

                // Hitung Pangsit
                if (namaItem.toLowerCase().includes("pangsit")) {
                    penghitung.Pangsit += parseInt(jumlah);
                }
            });
        });

        // Tampilkan hasil penghitungan
        document.getElementById("penghitung-item").innerHTML = `
            <p>Bakso: ${penghitung.Bakso} Porsi</p>
            <p>Pangsit: ${penghitung.Pangsit} Porsi</p>
        `;
    }

    function tampilkanSemua() {
        tampilkanRiwayat(); // Tampilkan semua riwayat penjualan
    }

    function filterCash() {
        tampilkanRiwayat("CASH");
    }

    function filterCashless() {
        tampilkanRiwayat("CASHLESS");
    }

    document.addEventListener("DOMContentLoaded", function () {
        tampilkanSemua(); // Tampilkan semua riwayat penjualan saat halaman dimuat

        // Ambil data daftar item dari localStorage
        let daftar = JSON.parse(localStorage.getItem("daftarItem")) || [];
        let daftarItem = document.getElementById("daftar-item");

        // Tampilkan daftar item
        daftar.forEach((item, index) => {
            let row = `<tr>
                <td>${index + 1}</td>
                <td>${item.nama}</td>
                <td>Rp ${formatRupiah(item.harga)}</td>
                <td>
                    <button onclick="hapusItem(${index})" class="batalkan-perubahan">Hapus</button>
                </td>
            </tr>`;
            daftarItem.innerHTML += row;
        });

        // Tambah item ke daftar
        let formItem = document.getElementById("form-item");
        formItem.addEventListener("submit", function (e) {
            e.preventDefault();
            let nama = document.getElementById("nama-item").value;
            let harga = hapusPemisahRibuan(document.getElementById("harga-item").value);

            let newItem = { nama, harga };
            daftar.push(newItem);
            localStorage.setItem("daftarItem", JSON.stringify(daftar));

            let row = `<tr>
                <td>${daftar.length}</td>
                <td>${nama}</td>
                <td>Rp ${formatRupiah(harga)}</td>
                <td>
                    <button onclick="hapusItem(${daftar.length - 1})" class="batalkan-perubahan">Hapus</button>
                </td>
            </tr>`;
            daftarItem.innerHTML += row;

            formItem.reset();
        });
    });

    function tampilkanHalaman(halaman) {
        document.getElementById("kasir").style.display = (halaman === 'kasir') ? "block" : "none";
        document.getElementById("database").style.display = (halaman === 'database') ? "block" : "none";
    }

    function bukaKasir() {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("kasir-popup").style.display = "block";

        // Ambil data daftar item dari localStorage
        let daftar = JSON.parse(localStorage.getItem("daftarItem")) || [];
        let daftarItemKasir = document.getElementById("daftar-item-kasir");

        // Kosongkan daftar item kasir
        daftarItemKasir.innerHTML = "";

        // Tampilkan tombol item
        daftar.forEach((item) => {
            let button = `<button class="item-button" onclick="tambahKeBelanja('${item.nama}', ${item.harga})">${item.nama} - Rp ${formatRupiah(item.harga)}</button>`;
            daftarItemKasir.innerHTML += button;
        });

        // Perbarui daftar belanja
        perbaruiDaftarBelanja();
    }

    function tutupKasir() {
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        if (belanja.length > 0) {
            alert("Tolong Selesaikan Transaksi!");
            return; // Jangan tutup pop-up jika ada item dalam daftar belanja
        }

        document.getElementById("overlay").style.display = "none";
        document.getElementById("kasir-popup").style.display = "none";
    }

    function tambahKeBelanja(nama, harga) {
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        let item = belanja.find((item) => item.nama === nama);

        if (item) {
            item.jumlah += 1; // Tambah jumlah jika item sudah ada
        } else {
            belanja.push({ nama, harga, jumlah: 1 }); // Tambah item baru ke belanja
        }

        localStorage.setItem("belanja", JSON.stringify(belanja));
        perbaruiDaftarBelanja();
    }

    function perbaruiDaftarBelanja() {
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        let daftarBelanja = document.getElementById("daftar-belanja");
        let totalBayar = 0;

        // Gabungkan item yang sama
        let belanjaGabung = [];
        belanja.forEach((item) => {
            let itemExist = belanjaGabung.find((i) => i.nama === item.nama);
            if (itemExist) {
                itemExist.jumlah += item.jumlah;
            } else {
                belanjaGabung.push({ ...item });
            }
        });

        // Kosongkan daftar belanja
        daftarBelanja.innerHTML = "";

        // Tampilkan item belanja
        belanjaGabung.forEach((item, index) => {
            let totalHarga = item.harga * item.jumlah;
            totalBayar += totalHarga;

            let row = `<tr>
                <td>${item.nama}</td>
                <td>${item.jumlah}</td>
                <td>Rp ${formatRupiah(item.harga)}</td>
                <td>Rp ${formatRupiah(totalHarga)}</td>
                <td>
                    <button onclick="hapusDariBelanja('${item.nama}')" class="batalkan-perubahan">Hapus</button>
                </td>
            </tr>`;
            daftarBelanja.innerHTML += row;
        });

        // Tampilkan total bayar
        document.getElementById("total-bayar").innerText = `Total Bayar: Rp ${formatRupiah(totalBayar)}`;

        // Ubah warna tombol Tutup jika ada item dalam daftar belanja
        let tombolTutup = document.querySelector("#kasir-popup button[onclick='tutupKasir()']");
        if (belanja.length > 0) {
            tombolTutup.classList.add("tutup-merah");
        } else {
            tombolTutup.classList.remove("tutup-merah");
        }
    }

    function hapusDariBelanja(nama) {
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        belanja = belanja.filter((item) => item.nama !== nama); // Hapus item dari belanja
        localStorage.setItem("belanja", JSON.stringify(belanja));
        perbaruiDaftarBelanja();
    }

    function hitungKembalian() {
        let totalBayar = parseFloat(hapusPemisahRibuan(document.getElementById("total-bayar").innerText.replace("Total Bayar: Rp ", "")));
        let uangPembayaran = parseFloat(hapusPemisahRibuan(document.getElementById("uang-pembayaran").value));

        if (isNaN(uangPembayaran)) {
            alert("Masukkan jumlah uang pembayaran!");
            return;
        }

        if (uangPembayaran < totalBayar) {
            alert("Uang pembayaran tidak cukup!");
            return;
        }

        let kembalian = uangPembayaran - totalBayar;
        document.getElementById("kembalian").innerText = `Kembalian: Rp ${formatRupiah(kembalian)}`;
    }

    function simpanTransaksi() {
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        if (belanja.length === 0) {
            alert("Belanjaan kosong!");
            return;
        }

        let riwayat = JSON.parse(localStorage.getItem("riwayatPenjualan")) || [];
        let totalBayar = belanja.reduce((total, item) => total + item.harga * item.jumlah, 0);

        // Jika metode pembayaran adalah GRAB, gunakan total harga GRAB
        if (metodePembayaranTerpilih === "GRAB") {
            let totalHargaGrab = hapusPemisahRibuan(document.getElementById("total-harga-grab").value);
            if (!totalHargaGrab || isNaN(totalHargaGrab)) {
                alert("Masukkan total harga GRAB yang valid!");
                return;
            }
            totalBayar = parseFloat(totalHargaGrab);
        }

        // Format nama item dengan jumlah (misal: "2 Bakso Ori, 3 Bakso Telur")
        let namaItem = belanja.map(item => `${item.jumlah} ${item.nama}`).join(", ");

        let transaksi = {
            nama: namaItem,
            jumlah: belanja.reduce((total, item) => total + item.jumlah, 0),
            total: totalBayar,
            keterangan: metodePembayaranTerpilih || "CASH", // Default ke CASH jika tidak ada metode yang dipilih
            lunas: false, // Default status lunas
        };

        if (indexTransaksiEdit !== null) {
            // Jika sedang dalam mode edit, perbarui transaksi yang ada
            riwayat[indexTransaksiEdit] = transaksi;
            indexTransaksiEdit = null; // Reset mode edit
        } else {
            // Jika tidak, tambahkan transaksi baru
            riwayat.push(transaksi);
        }

        localStorage.setItem("riwayatPenjualan", JSON.stringify(riwayat));
        localStorage.removeItem("belanja"); // Kosongkan belanja
        metodePembayaranTerpilih = ""; // Reset metode pembayaran
        tutupKasir();
        location.reload(); // Muat ulang halaman untuk memperbarui tampilan
    }

    function hapusItem(index) {
        let pin = prompt("Masukkan PIN untuk menghapus item:");
        if (pin !== "0000") {
            alert("PIN salah! Penghapusan dibatalkan.");
            return;
        }

        let daftar = JSON.parse(localStorage.getItem("daftarItem")) || [];
        daftar.splice(index, 1); // Hapus item dari array
        localStorage.setItem("daftarItem", JSON.stringify(daftar)); // Simpan kembali ke localStorage
        location.reload(); // Muat ulang halaman untuk memperbarui tampilan
    }

    function tandaiLunas(index) {
        let riwayat = JSON.parse(localStorage.getItem("riwayatPenjualan")) || [];
        riwayat[index].lunas = true; // Tandai sebagai lunas
        localStorage.setItem("riwayatPenjualan", JSON.stringify(riwayat));
        location.reload(); // Muat ulang halaman untuk memperbarui tampilan
    }

    function editTransaksi(index) {
        let riwayat = JSON.parse(localStorage.getItem("riwayatPenjualan")) || [];
        let transaksi = riwayat[index];

        // Simpan indeks transaksi yang sedang diedit
        indexTransaksiEdit = index;

        // Tambahkan item ke keranjang
        let belanja = JSON.parse(localStorage.getItem("belanja")) || [];
        transaksi.nama.split(", ").forEach((item) => {
            let [jumlah, ...nama] = item.split(" ");
            let namaItem = nama.join(" ");
            let harga = JSON.parse(localStorage.getItem("daftarItem")).find((item) => item.nama === namaItem).harga;
            belanja.push({ nama: namaItem, harga, jumlah: parseInt(jumlah) });
        });

        localStorage.setItem("belanja", JSON.stringify(belanja));

        // Aktifkan metode pembayaran sesuai transaksi
        pilihMetodePembayaran(transaksi.keterangan);

        // Jika metode GRAB, isi nilai total harga GRAB
        if (transaksi.keterangan === "GRAB") {
            document.getElementById("total-harga-grab").value = formatRupiah(transaksi.total);
        }

        // Tampilkan tombol "Batalkan Perubahan"
        document.getElementById("batalkan-perubahan").style.display = "inline-block";

        // Buka pop-up kasir
        bukaKasir();
    }

    function batalkanPerubahan() {
        // Reset mode edit
        indexTransaksiEdit = null;
        localStorage.removeItem("belanja"); // Kosongkan belanja
        document.getElementById("batalkan-perubahan").style.display = "none"; // Sembunyikan tombol "Batalkan Perubahan"
        tutupKasir();
    }

    function hapusTransaksi(index) {
        let pin = prompt("Masukkan PIN untuk menghapus transaksi:");
        if (pin !== "0000") {
            alert("PIN salah! Penghapusan dibatalkan.");
            return;
        }

        let riwayat = JSON.parse(localStorage.getItem("riwayatPenjualan")) || [];
        riwayat.splice(index, 1); // Hapus transaksi dari riwayat
        localStorage.setItem("riwayatPenjualan", JSON.stringify(riwayat));
        location.reload(); // Muat ulang halaman untuk memperbarui tampilan
    }
</script>

</body>
</html>
